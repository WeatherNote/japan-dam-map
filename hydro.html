<!DOCTYPE html>
<html lang="ja" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ê∞¥ÂäõÁô∫Èõª„ÉÄ„É† Âú∞ÊñπÂà•Ë≤ØÊ∞¥Áéá | Hydroelectric Dam Regional Stats</title>
    <meta name="description" content="Êó•Êú¨„ÅÆÊ∞¥ÂäõÁô∫Èõª„ÉÄ„É†„ÅÆÂú∞ÊñπÂà•Ë≤ØÊ∞¥Áéá„Çí„Ç´„É©„Éº„Éû„ÉÉ„Éó„ÅßË°®Á§∫" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="src/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            overflow: auto;
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .hydro-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .hydro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .hydro-header h1 {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #2563eb, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hydro-header .subtitle {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .hydro-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hydro-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .summary-card .card-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .summary-card .card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
        }

        .summary-card .card-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .region-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .region-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .region-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .region-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .region-card-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .region-rate {
            font-size: 28px;
            font-weight: 700;
        }

        .region-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .region-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.8s ease;
        }

        .region-dam-list {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .region-dam-list .dam-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .region-dam-list .dam-item:last-child {
            border-bottom: none;
        }

        .dam-rate-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }

        .chart-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 32px;
        }

        .chart-section h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .chart-section canvas {
            width: 100% !important;
            max-height: 400px;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .region-card {
            animation: fadeInUp 0.4s ease forwards;
        }

        .region-card:nth-child(1) {
            animation-delay: 0.05s;
        }

        .region-card:nth-child(2) {
            animation-delay: 0.1s;
        }

        .region-card:nth-child(3) {
            animation-delay: 0.15s;
        }

        .region-card:nth-child(4) {
            animation-delay: 0.2s;
        }

        .region-card:nth-child(5) {
            animation-delay: 0.25s;
        }

        .region-card:nth-child(6) {
            animation-delay: 0.3s;
        }

        .region-card:nth-child(7) {
            animation-delay: 0.35s;
        }

        .region-card:nth-child(8) {
            animation-delay: 0.4s;
        }
    </style>
</head>

<body>
    <div class="hydro-page">
        <div class="hydro-header">
            <div>
                <h1 id="page-title">‚ö° Ê∞¥ÂäõÁô∫Èõª„ÉÄ„É† Âú∞ÊñπÂà•Ë≤ØÊ∞¥Áéá</h1>
                <div class="subtitle" id="page-subtitle">Ê∞¥ÂäõÁô∫ÈõªË®≠ÂÇô„ÇíÊåÅ„Å§„ÉÄ„É†„ÅÆÂú∞ÊñπÂà•ÂêàË®àË≤ØÊ∞¥Áéá„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßË°®Á§∫</div>
            </div>
            <div class="hydro-nav">
                <a href="index.html" class="btn-icon" id="btn-back">
                    <span>‚Üê </span><span id="btn-back-label">„É°„Ç§„É≥„Éû„ÉÉ„Éó„Å´Êàª„Çã</span>
                </a>
                <button id="btn-theme" class="btn-icon" title="Toggle Theme" aria-label="Toggle Theme">
                    <span id="theme-icon">üåô</span>
                </button>
                <button id="btn-lang" class="btn-icon" title="Language" aria-label="Toggle Language">
                    <span id="lang-label">EN</span>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="hydro-summary" id="summary-cards"></div>

        <!-- Chart -->
        <div class="chart-section">
            <h2 id="chart-title">Âú∞ÊñπÂà•Ë≤ØÊ∞¥ÁéáÊØîËºÉ</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <canvas id="region-chart"></canvas>
                </div>
                <div id="regional-map"
                    style="flex: 1; min-width: 300px; height: 400px; border-radius: 8px; z-index: 1;"></div>
            </div>
        </div>

        <!-- Regional Cards -->
        <div class="region-grid" id="region-grid"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="src/hydro_map.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="src/i18n.js"></script>
    <script src="src/theme.js"></script>
    <script>
        // ===== Page-specific i18n =====
        const pageI18n = {
            ja: {
                page_title: '‚ö° Ê∞¥ÂäõÁô∫Èõª„ÉÄ„É† Âú∞ÊñπÂà•Ë≤ØÊ∞¥Áéá',
                page_subtitle: 'Ê∞¥ÂäõÁô∫ÈõªË®≠ÂÇô„ÇíÊåÅ„Å§„ÉÄ„É†„ÅÆÂú∞ÊñπÂà•ÂêàË®àË≤ØÊ∞¥Áéá„Çí„É™„Ç¢„É´„Çø„Ç§„É†„ÅßË°®Á§∫',
                back_label: '„É°„Ç§„É≥„Éû„ÉÉ„Éó„Å´Êàª„Çã',
                chart_title: 'Âú∞ÊñπÂà•Ë≤ØÊ∞¥ÁéáÊØîËºÉ',
                total_hydro: 'Ê∞¥ÂäõÁô∫Èõª„ÉÄ„É†Á∑èÊï∞',
                avg_rate: 'ÂÖ®ÂõΩÂπ≥ÂùáË≤ØÊ∞¥Áéá',
                total_capacity: 'Á∑èÊúâÂäπË≤ØÊ∞¥Èáè',
                unit_dam: 'Âü∫',
                unit_m3: '‰∏ám¬≥',
                dam_count: 'Âü∫',
                region_rate: 'ÂêàË®àË≤ØÊ∞¥Áéá',
            },
            en: {
                page_title: '‚ö° Hydroelectric Dam Regional Stats',
                page_subtitle: 'Regional aggregate reservoir rates for dams with hydroelectric facilities',
                back_label: 'Back to Main Map',
                chart_title: 'Regional Reservoir Rate Comparison',
                total_hydro: 'Total Hydro Dams',
                avg_rate: 'National Average Rate',
                total_capacity: 'Total Effective Capacity',
                unit_dam: 'dams',
                unit_m3: '√ó10k m¬≥',
                dam_count: 'dams',
                region_rate: 'Aggregate Rate',
            }
        };

        function pt(key) {
            const lang = I18n.getLang();
            return (pageI18n[lang] || pageI18n.ja)[key] || key;
        }

        // ===== Data Loading =====
        async function loadData() {
            try {
                const [damsRes, realtimeRes] = await Promise.all([
                    fetch('data/dams.json'),
                    fetch('data/realtime.json')
                ]);
                const damsData = await damsRes.json();
                const realtimeData = await realtimeRes.json();

                // Merge realtime into dams
                const dams = damsData.dams.map(dam => {
                    const rt = realtimeData[dam.id] || {};
                    return { ...dam, ...rt };
                });

                // Filter hydroelectric dams OR dams with P (power) purpose
                const hydroDams = dams.filter(d =>
                    d.type === 'hydroelectric' ||
                    (d.purpose && d.purpose.includes('P'))
                );

                return hydroDams;
            } catch (err) {
                console.error('Failed to load data:', err);
                return [];
            }
        }

        // ===== Region mapping =====
        const regionPrefectures = {
            hokkaido: [0],
            tohoku: [1, 2, 3, 4, 5, 6],
            kanto: [7, 8, 9, 10, 11, 12, 13],
            chubu: [14, 15, 16, 17, 18, 19, 20, 21, 22],
            kinki: [23, 24, 25, 26, 27, 28, 29],
            chugoku: [30, 31, 32, 33, 34],
            shikoku: [35, 36, 37, 38],
            kyushu: [39, 40, 41, 42, 43, 44, 45, 46]
        };

        const regionOrder = ['hokkaido', 'tohoku', 'kanto', 'chubu', 'kinki', 'chugoku', 'shikoku', 'kyushu'];

        function getColor(rate) {
            if (rate === null || rate === undefined) return '#94a3b8';
            if (rate >= 90) return '#2563eb';
            if (rate >= 70) return '#16a34a';
            if (rate >= 50) return '#eab308';
            if (rate >= 30) return '#ea580c';
            return '#dc2626';
        }

        // ===== Render =====
        function renderSummary(hydroDams) {
            const container = document.getElementById('summary-cards');
            const withRate = hydroDams.filter(d => d.rate !== null && d.rate !== undefined);
            const avgRate = withRate.length > 0
                ? (withRate.reduce((s, d) => s + d.rate, 0) / withRate.length).toFixed(1)
                : '--';
            const totalCapacity = hydroDams.reduce((s, d) => s + (d.effectiveCapacity || 0), 0);

            container.innerHTML = `
        <div class="summary-card">
          <div class="card-icon">‚ö°</div>
          <div class="card-value">${hydroDams.length}</div>
          <div class="card-label">${pt('total_hydro')}</div>
        </div>
        <div class="summary-card">
          <div class="card-icon">üìä</div>
          <div class="card-value" style="color: ${getColor(parseFloat(avgRate))}">${avgRate}%</div>
          <div class="card-label">${pt('avg_rate')}</div>
        </div>
        <div class="summary-card">
          <div class="card-icon">üíß</div>
          <div class="card-value">${(totalCapacity / 10000).toLocaleString()}</div>
          <div class="card-label">${pt('total_capacity')} (${pt('unit_m3')})</div>
        </div>
      `;
        }

        function renderRegionCards(hydroDams) {
            const container = document.getElementById('region-grid');
            const lang = I18n.getLang();
            const regions = I18n.getRegions();

            container.innerHTML = regionOrder.map(regionKey => {
                const prefIndices = regionPrefectures[regionKey];
                const regionDams = hydroDams.filter(d => prefIndices.includes(d.prefectureIndex));
                const withRate = regionDams.filter(d => d.rate !== null && d.rate !== undefined);

                if (withRate.length === 0) return '';
                // Weighted average by effective capacity
                let avgRate;
                const totalEffective = withRate.reduce((s, d) => s + (d.effectiveCapacity || 0), 0);
                if (totalEffective > 0) {
                    avgRate = withRate.reduce((s, d) => s + (d.rate || 0) * (d.effectiveCapacity || 0), 0) / totalEffective;
                } else if (withRate.length > 0) {
                    avgRate = withRate.reduce((s, d) => s + d.rate, 0) / withRate.length;
                } else {
                    avgRate = null;
                }

                const rateText = avgRate !== null ? avgRate.toFixed(1) + '%' : '--';
                const color = getColor(avgRate);
                const fillPct = avgRate !== null ? Math.min(100, Math.max(0, avgRate)) : 0;

                const damListHtml = regionDams.map(d => {
                    const name = lang === 'en' && d.nameEn ? d.nameEn : (d.name || '');
                    const rate = d.rate !== null && d.rate !== undefined ? d.rate.toFixed(1) : '--';
                    const pillColor = getColor(d.rate);
                    return `<div class="dam-item">
            <span>${name}</span>
            <span class="dam-rate-pill" style="background: ${pillColor}">${rate}%</span>
          </div>`;
                }).join('');

                return `
          <div class="region-card" style="--region-color: ${color}">
            <div style="position:absolute;top:0;left:0;right:0;height:4px;background:${color}"></div>
            <div class="region-card-header">
              <h3>${regions[regionKey]}</h3>
              <span class="region-rate" style="color:${color}">${rateText}</span>
            </div>
            <div class="region-bar">
              <div class="region-bar-fill" style="width: ${fillPct}%; background: linear-gradient(90deg, ${color}, ${color}dd)"></div>
            </div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
              ${regionDams.length} ${pt('dam_count')} | ${pt('region_rate')}
            </div>
            <div class="region-dam-list">${damListHtml}</div>
          </div>
        `;
            }).join('');
        }

        let regionChart = null;
        function renderChart(hydroDams) {
            const canvas = document.getElementById('region-chart');
            if (regionChart) { regionChart.destroy(); regionChart = null; }

            const isDark = Theme.get() === 'dark';
            const regions = I18n.getRegions();
            const labels = [];
            const data = [];
            const colors = [];

            regionOrder.forEach(regionKey => {
                const prefIndices = regionPrefectures[regionKey];
                const regionDams = hydroDams.filter(d => prefIndices.includes(d.prefectureIndex));
                const withRate = regionDams.filter(d => d.rate !== null && d.rate !== undefined);
                const totalEffective = withRate.reduce((s, d) => s + (d.effectiveCapacity || 0), 0);
                let avgRate;
                if (totalEffective > 0) {
                    avgRate = withRate.reduce((s, d) => s + (d.rate || 0) * (d.effectiveCapacity || 0), 0) / totalEffective;
                } else if (withRate.length > 0) {
                    avgRate = withRate.reduce((s, d) => s + d.rate, 0) / withRate.length;
                } else {
                    avgRate = 0;
                }
                labels.push(regions[regionKey]);
                data.push(Math.round(avgRate * 10) / 10);
                colors.push(getColor(avgRate));
            });

            regionChart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: pt('region_rate'),
                        data,
                        backgroundColor: colors.map(c => c + '33'),
                        borderColor: colors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: isDark ? '#1e293b' : '#fff',
                            titleColor: isDark ? '#f1f5f9' : '#0f172a',
                            bodyColor: isDark ? '#94a3b8' : '#475569',
                            borderColor: isDark ? '#334155' : '#e2e8f0',
                            borderWidth: 1,
                            callbacks: {
                                label: ctx => `${pt('region_rate')}: ${ctx.parsed.y}%`
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            ticks: {
                                color: isDark ? '#64748b' : '#94a3b8',
                                callback: v => v + '%',
                                font: { size: 11 }
                            },
                            grid: { color: isDark ? '#1e293b' : '#f0f4f8' }
                        },
                        x: {
                            ticks: {
                                color: isDark ? '#64748b' : '#94a3b8',
                                font: { size: 12, weight: 500 }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // ===== UI Text Update =====
        function updatePageText() {
            document.getElementById('page-title').textContent = pt('page_title');
            document.getElementById('page-subtitle').textContent = pt('page_subtitle');
            document.getElementById('btn-back-label').textContent = pt('back_label');
            document.getElementById('chart-title').textContent = pt('chart_title');
        }

        // ===== Init =====
        let allHydroDams = [];

        async function init() {
            // Theme
            Theme.init();
            document.getElementById('btn-theme').addEventListener('click', () => {
                Theme.toggle();
                renderAll();
            });

            // Language
            document.getElementById('btn-lang').addEventListener('click', () => {
                const newLang = I18n.getLang() === 'ja' ? 'en' : 'ja';
                I18n.setLang(newLang);
                document.getElementById('lang-label').textContent = newLang === 'ja' ? 'EN' : 'JA';
                updatePageText();
                renderAll();
            });

            allHydroDams = await loadData();
            updatePageText();
            renderAll();
        }

        function calculateRegionRates(hydroDams) {
            const regionRates = {};
            // Use same regions as map
            const regionPrefectures = {
                hokkaido: [0],
                tohoku: [1, 2, 3, 4, 5, 6],
                kanto: [7, 8, 9, 10, 11, 12, 13],
                chubu: [14, 15, 16, 17, 18, 19, 20, 21, 22],
                kinki: [23, 24, 25, 26, 27, 28, 29],
                chugoku: [30, 31, 32, 33, 34],
                shikoku: [35, 36, 37, 38],
                kyushu: [39, 40, 41, 42, 43, 44, 45, 46]
            };

            regionOrder.forEach(key => {
                const prefIndices = regionPrefectures[key];
                const regionDams = hydroDams.filter(d => prefIndices.includes(d.prefectureIndex));
                const withRate = regionDams.filter(d => d.rate !== null && d.rate !== undefined);

                let avgRate = null;
                if (withRate.length > 0) {
                    const totalEffective = withRate.reduce((s, d) => s + (d.effectiveCapacity || 0), 0);
                    if (totalEffective > 0) {
                        avgRate = withRate.reduce((s, d) => s + d.rate * (d.effectiveCapacity || 0), 0) / totalEffective;
                    } else {
                        avgRate = withRate.reduce((s, d) => s + d.rate, 0) / withRate.length;
                    }
                }
                regionRates[key] = avgRate;
            });
            return regionRates;
        }

        function renderAll() {
            const regionRates = calculateRegionRates(allHydroDams);
            renderSummary(allHydroDams);
            renderRegionCards(allHydroDams); // Could optimized to use regionRates but logic is embedded
            // renderSummary(allHydroDams); // Duplicate call?
            // renderRegionCards(allHydroDams); // Duplicate call?
            renderChart(allHydroDams);
            HydroMap.init(allHydroDams, regionRates);
        }

        init();
    </script>
</body>

</html>